<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chet</title>
    <link rel="icon" type="image/png" id="favicon">
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;height: 100vh;overflow: hidden;background: #36393f; color: #dcddde;}
        
        .container {display: flex;height: 100vh;}
        
        /* Sidebar (Left) */
        .sidebar {width: 240px;background: #2f3136;display: flex;flex-direction: column; flex-shrink: 0;}
        .server-header {height: 48px;padding: 0 16px;display: flex;align-items: center;border-bottom: 1px solid #202225;color: #fff;font-weight: 600;font-size: 15px; box-shadow: 0 1px 0 rgba(0,0,0,0.2);}
        
        .channels {flex: 1;overflow-y: auto;padding: 8px;}
        .channel-section {margin-bottom: 16px;}
        .section-header {color: #96989d;font-size: 12px;font-weight: 600;text-transform: uppercase;margin-bottom: 4px;padding: 0 8px;}
        
        .channel {padding: 6px 8px;margin: 2px 0;border-radius: 4px;color: #96989d;cursor: pointer;display: flex;align-items: center;justify-content: space-between;font-size: 14px;transition: all 0.15s;}
        .channel:hover {background: #3a3c42;color: #dcddde;}
        .channel.active {background: #404249;color: #fff;}
        .channel-name {display: flex;align-items: center;flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .channel-name::before {content: '#';margin-right: 6px;color: #72767d;font-size: 18px;}
        .channel.private .channel-name::before {content: '@'; font-size: 14px;}
        
        /* Online Users (Back in Sidebar) */
        .online-users {padding: 8px;border-top: 1px solid #202225;max-height: 250px;overflow-y: auto; background: #2f3136;}
        .online-header {color: #96989d;font-size: 12px;font-weight: 600;text-transform: uppercase;margin-bottom: 8px; padding: 0 4px;}
        .user-list-item {padding: 6px 8px;color: #96989d;font-size: 14px;display: flex;align-items: center;justify-content: space-between;border-radius: 4px;transition: 0.1s;}
        .user-list-item:hover {background: #3a3c42; color: #fff;}
        .user-item-name {display: flex; align-items: center; gap: 6px;}
        .status-dot {width: 8px; height: 8px; border-radius: 50%; background: #3ba55d;}
        
        /* DM Button (Restored) */
        .dm-btn {opacity: 0;background: #5865f2;color: #fff;border: none;padding: 2px 6px;border-radius: 3px;font-size: 10px;cursor: pointer;}
        .user-list-item:hover .dm-btn {opacity: 1;}
        .dm-btn:hover {background: #4752c4;}

        /* User Area (Bottom) */
        .user-area {height: 52px;background: #292b2f;padding: 0 8px;display: flex;align-items: center;border-top: 1px solid #202225;}
        .user-avatar {width: 32px;height: 32px;border-radius: 50%;background: #5865f2;display: flex;align-items: center;justify-content: center;color: #fff;font-weight: 600;margin-right: 8px;}
        .user-info {flex: 1;}
        .username {color: #fff;font-size: 14px;font-weight: 500;}
        .connection-status {font-size: 11px; color: #b9bbbe;}
        .admin-lock-btn {background: transparent; border: none; color: #b9bbbe; cursor: pointer; padding: 6px;}
        .admin-lock-btn:hover {color: #fff;}
        .admin-lock-btn.active {color: #3ba55d;}

        /* Main Content */
        .main-content {flex: 1;display: flex;flex-direction: column;background: #36393f;}
        .chat-header {height: 48px;padding: 0 16px;display: flex;align-items: center;border-bottom: 1px solid #202225;color: #fff; box-shadow: 0 1px 0 rgba(0,0,0,0.1);}
        .messages {flex: 1;overflow-y: auto;padding: 16px;}
        .message {display: flex;padding: 4px 0;margin-bottom: 12px;}
        .message:hover {background: #32353b; margin: 0 -16px 12px; padding: 4px 16px;}
        .message-avatar {width: 40px;height: 40px;border-radius: 50%;background: #5865f2;margin-right: 16px;flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; cursor: pointer;}
        
        .message-content {flex: 1; min-width: 0;}
        .message-header {display: flex;align-items: baseline;margin-bottom: 4px;}
        .message-author {color: #fff;font-weight: 500;font-size: 15px;margin-right: 8px; cursor: pointer;}
        .message-author:hover {text-decoration: underline;}
        .message-timestamp {color: #72767d;font-size: 12px;}
        .message-text {color: #dcddde;font-size: 15px;line-height: 1.4;word-wrap: break-word;}
        .message-img {max-width: 300px; border-radius: 5px; margin-top: 5px; cursor: pointer;}

        /* Input Area with Send Button */
        .input-area {padding: 16px;}
        .input-wrapper {background: #40444b;border-radius: 8px;padding: 0 16px;display: flex;align-items: center;}
        .attach-btn {background: transparent;border: none;color: #b9bbbe;cursor: pointer;font-size: 20px;margin-right: 12px;}
        .message-input {flex: 1;background: none;border: none;color: #dcddde;font-size: 15px;outline: none; padding: 12px 0;}
        .send-btn {background: #5865f2; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; margin-left: 8px; transition: 0.2s;}
        .send-btn:hover {background: #4752c4;}

        /* Admin Menu */
        .admin-menu {position: fixed; background: #18191c; border-radius: 4px; width: 200px; padding: 6px; z-index: 1000; box-shadow: 0 8px 16px rgba(0,0,0,0.3); display: none;}
        .admin-menu.visible {display: block;}
        .admin-item {padding: 8px; color: #b9bbbe; font-size: 14px; cursor: pointer; border-radius: 2px;}
        .admin-item:hover {background: #4752c4; color: #fff;}
        .admin-item.danger {color: #ed4245;}
        .admin-item.danger:hover {background: #ed4245; color: #fff;}
        
        /* Modal */
        .modal {display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;}
        .modal.active {display: flex;}
        .modal img {max-width: 90%; max-height: 90%; border-radius: 4px;}

        ::-webkit-scrollbar {width: 8px;}
        ::-webkit-scrollbar-track {background: #2f3136;}
        ::-webkit-scrollbar-thumb {background: #202225;border-radius: 4px;}
    </style>
</head>
<body>
    <div class="admin-menu" id="adminMenu">
        <div style="padding: 4px 8px; font-size: 11px; font-weight: 700; color: #72767d; text-transform: uppercase;" id="adminTargetName">User</div>
        <div class="admin-item" onclick="adminAction('mute', 1)">Mute 1 Min</div>
        <div class="admin-item" onclick="adminAction('mute', 5)">Mute 5 Mins</div>
        <div class="admin-item" onclick="adminAction('mute', 999999)">Mute Forever</div>
        <div class="admin-item danger" onclick="adminAction('kick')">Kick to Google</div>
        <div class="admin-item danger" onclick="adminAction('ban')">Ban IP</div>
    </div>

    <div class="modal" id="imageModal" onclick="this.classList.remove('active')"><img id="modalImg" src=""></div>

    <div class="container">
        <div class="sidebar">
            <div class="server-header">The Chet</div>
            <div class="channels" id="channelList">
                <div class="channel-section">
                    <div class="section-header">Channels</div>
                    <div class="channel active" data-id="general"><span class="channel-name">general</span></div>
                    <div class="channel" data-id="gaming"><span class="channel-name">gaming</span></div>
                    <div class="channel" data-id="memes"><span class="channel-name">memes</span></div>
                    <div class="channel" data-id="random"><span class="channel-name">random</span></div>
                </div>
                <div class="channel-section">
                    <div class="section-header">Direct Messages</div>
                    <div id="dmList"></div>
                </div>
            </div>
            
            <div class="online-users">
                <div class="online-header">Online Users</div>
                <div id="userList"></div>
            </div>

            <div class="user-area">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="username" id="usernameDisplay">User</div>
                    <div class="connection-status" id="connectionStatus">Connecting...</div>
                </div>
                <button class="admin-lock-btn" id="adminBtn" title="Admin Login">ðŸ”’</button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <span style="font-size: 20px; color: #72767d; margin-right: 6px;">#</span>
                <span style="font-weight: 600;" id="currentChannelHeader">general</span>
                <div style="flex:1"></div>
                <div style="font-size: 12px; color: #b9bbbe;" id="typingIndicator"></div>
            </div>
            
            <div class="messages" id="messageArea"></div>
            
            <div class="input-area">
                <div class="input-wrapper">
                    <input type="file" id="fileInput" hidden accept="image/*">
                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">+</button>
                    <input type="text" class="message-input" id="messageInput" placeholder="Message #general">
                    <button class="send-btn" id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const state={username:'',isAdmin:false,ws:null,currentChannel:'general',chatType:'public',privateChatId:null,targetUser:null,selectedAdminTarget:null};
        const els={msgArea:document.getElementById('messageArea'),input:document.getElementById('messageInput'),userList:document.getElementById('userList'),header:document.getElementById('currentChannelHeader'),dmList:document.getElementById('dmList'),adminMenu:document.getElementById('adminMenu'),adminBtn:document.getElementById('adminBtn'),sendBtn:document.getElementById('sendBtn')};

        // --- Admin Logic ---
        els.adminBtn.onclick = () => {
            if(state.isAdmin) return alert("Already admin");
            const p = prompt("Admin Password:");
            if(p) send({type:'adminLogin', password:p});
        };
        
        // Right Click to Open Menu
        function showAdminMenu(e, username) {
            if (!state.isAdmin || username === state.username) return;
            e.preventDefault();
            state.selectedAdminTarget = username;
            document.getElementById('adminTargetName').textContent = username;
            els.adminMenu.style.top = `${e.clientY}px`;
            els.adminMenu.style.left = `${e.clientX}px`;
            els.adminMenu.classList.add('visible');
        }
        function adminAction(act, dur=0) {
            send({type:'adminAction', action:act, target:state.selectedAdminTarget, duration:dur});
            els.adminMenu.classList.remove('visible');
        }
        document.addEventListener('click', e => { if(!e.target.closest('.admin-menu')) els.adminMenu.classList.remove('visible'); });

        // --- Core ---
        function init(){
            state.username = prompt("Enter Username:") || "User"+Math.floor(Math.random()*100);
            document.getElementById('usernameDisplay').textContent = state.username;
            document.getElementById('userAvatar').textContent = state.username[0].toUpperCase();
            connect();
        }
        function connect(){
            state.ws = new WebSocket(location.protocol==='https:'?'wss://'+location.host:'ws://'+location.host);
            state.ws.onopen=()=>{
                document.getElementById('connectionStatus').textContent="Connected";
                document.getElementById('connectionStatus').style.color="#3ba55d";
                send({type:'join', username:state.username});
                send({type:'getHistory', channel:'general'});
            };
            state.ws.onmessage=e=>handleMessage(JSON.parse(e.data));
            state.ws.onclose=()=>{
                document.getElementById('connectionStatus').textContent="Reconnecting...";
                document.getElementById('connectionStatus').style.color="#ed4245";
                setTimeout(connect,3000);
            };
        }
        function send(d){ if(state.ws&&state.ws.readyState===1) state.ws.send(JSON.stringify(d)); }

        function handleMessage(d){
            switch(d.type){
                case 'message': renderMessage(d.message); break;
                case 'history': els.msgArea.innerHTML=''; d.messages.forEach(renderMessage); break;
                case 'userList': updateUserList(d.users); break;
                case 'adminSuccess': state.isAdmin=true; els.adminBtn.classList.add('active'); alert("Admin Mode ON"); break;
                case 'kicked': window.location.href="https://google.com"; break;
                case 'error': alert(d.message); break;
                case 'privateChatRequest': if(confirm(`${d.from} wants to DM. Accept?`)) send({type:'privateChatResponse', from:d.from, accepted:true}); break;
                case 'privateChatAccepted': startDM(d.chatId, d.with); break;
                case 'privateMessage': if(state.chatType==='private' && state.privateChatId===d.message.chatId) renderMessage(d.message); break;
            }
        }

        function updateUserList(users){
            els.userList.innerHTML = '';
            users.forEach(u => {
                const d = document.createElement('div');
                d.className = 'user-list-item';
                d.innerHTML = `
                    <div class="user-item-name"><div class="status-dot"></div> ${u}</div>
                    ${u !== state.username ? '<button class="dm-btn">DM</button>' : ''}
                `;
                if(u !== state.username) {
                    d.querySelector('.dm-btn').onclick = () => requestDM(u);
                    d.oncontextmenu = (e) => showAdminMenu(e, u);
                }
                els.userList.appendChild(d);
            });
        }

        function renderMessage(m){
            if(state.chatType==='public' && m.channel!==state.currentChannel) return;
            const div = document.createElement('div');
            div.className = 'message';
            let content = `<div class="message-text">${m.text||''}</div>`;
            if(m.isImage) content = `<img class="message-img" src="${m.imageData}" onclick="document.getElementById('modalImg').src=this.src;document.getElementById('imageModal').classList.add('active')">`;
            
            div.innerHTML = `
                <div class="message-avatar" onclick="showAdminMenu(event, '${m.author}')">${m.author[0].toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author" onclick="showAdminMenu(event, '${m.author}')">${m.author}</span>
                        <span class="message-timestamp">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                    ${content}
                </div>`;
            els.msgArea.appendChild(div);
            els.msgArea.scrollTop = els.msgArea.scrollHeight;
        }

        function requestDM(target){
            if(confirm(`DM ${target}?`)) send({type:'privateChatRequest', targetUsername:target});
        }

        function startDM(chatId, withUser){
            state.chatType='private'; state.privateChatId=chatId; state.targetUser=withUser; state.currentChannel=null;
            els.header.textContent = '@'+withUser; els.header.parentElement.classList.add('private');
            els.input.placeholder = `Message @${withUser}`; els.msgArea.innerHTML='';
            
            if(!document.querySelector(`[data-chat="${chatId}"]`)){
                const d=document.createElement('div'); d.className='channel private active'; d.dataset.chat=chatId;
                d.innerHTML=`<span class="channel-name">${withUser}</span>`;
                d.onclick=()=>startDM(chatId,withUser);
                els.dmList.appendChild(d);
            }
            document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
        }

        function sendMessage(){
            const text = els.input.value.trim();
            if(!text) return;
            const p = {
                type: state.chatType==='private'?'privateMessage':'message',
                text, channel: state.currentChannel, chatId: state.privateChatId, targetUsername: state.targetUser
            };
            send(p); els.input.value='';
        }

        els.sendBtn.onclick = sendMessage;
        els.input.onkeypress = e => { if(e.key==='Enter') sendMessage(); };
        
        document.getElementById('fileInput').onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                send({
                    type: state.chatType==='private'?'privateImageMessage':'imageMessage',
                    imageData: ev.target.result, channel: state.currentChannel, chatId: state.privateChatId, targetUsername: state.targetUser
                });
            };
            r.readAsDataURL(f);
        };

        document.getElementById('channelList').onclick = e => {
            const c = e.target.closest('.channel');
            if(c && !c.classList.contains('private')){
                document.querySelectorAll('.channel').forEach(ch=>ch.classList.remove('active'));
                c.classList.add('active');
                state.currentChannel=c.dataset.id; state.chatType='public'; state.privateChatId=null;
                els.header.textContent=state.currentChannel; els.input.placeholder=`Message #${state.currentChannel}`;
                send({type:'getHistory', channel:state.currentChannel});
            }
        };

        init();
    </script>
</body>
</html>
