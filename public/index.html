<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üí¨</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;height:100vh;overflow:hidden;background:#36393f}
.container{display:flex;height:100vh}
.sidebar{width:240px;background:#2f3136;display:flex;flex-direction:column}
.sidebar.right{order:3;border-left:1px solid #202225}
.server-header{height:48px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #202225;color:#fff;font-weight:600;font-size:15px}
.channels{flex:1;overflow-y:auto;padding:8px}
.channel-section{margin-bottom:16px}
.section-header{color:#96989d;font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:4px;padding:0 8px}
.channel{padding:8px 12px;margin:2px 0;border-radius:4px;color:#96989d;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:14px;transition:all .15s;position:relative}
.channel:hover{background:#3a3c42;color:#dcddde}
.channel.active{background:#404249;color:#fff}
.channel.has-unread{font-weight:600}
.channel-name{display:flex;align-items:center}
.channel-name::before{content:'#';margin-right:6px;font-weight:600;color:#72767d}
.channel.private .channel-name::before{content:'@';color:#5865f2}
.unread-badge{background:#ed4245;color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700;min-width:18px;text-align:center;display:none}
.channel.has-unread .unread-badge{display:block}
.dm-badge{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#ed4245;color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700;min-width:18px;text-align:center}
.close-dm{opacity:0;background:none;border:none;color:#96989d;cursor:pointer;font-size:16px;transition:opacity .2s}
.channel:hover .close-dm{opacity:1}
.close-dm:hover{color:#ed4245}
.users-section{flex:1;overflow-y:auto;padding:8px}
.users-section-header{padding:8px 12px;color:#96989d;font-size:12px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.online-count{color:#3ba55d;font-size:11px}
.role-header{font-size:11px;font-weight:600;text-transform:uppercase;padding:8px 12px 4px;color:#96989d}
.user-item{padding:6px 12px;color:#dcddde;font-size:13px;display:flex;align-items:center;justify-content:space-between;border-radius:4px;margin:0 4px;transition:background .15s;cursor:pointer}
.user-item:hover{background:#3a3c42}
.user-name{display:flex;align-items:center;gap:6px}
.user-name::before{content:'‚óè';color:#3ba55d;font-size:8px}
.dm-btn{opacity:0;background:#5865f2;color:#fff;border:none;padding:3px 8px;border-radius:3px;font-size:10px;cursor:pointer;transition:opacity .2s}
.user-item:hover .dm-btn{opacity:1}
.user-area{height:52px;background:#292b2f;padding:0 8px;display:flex;align-items:center;cursor:pointer;transition:background .2s}
.user-area:hover{background:#2a2d31}
.user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;margin-right:8px;font-size:14px}
.user-display-name{color:#fff;font-size:14px;font-weight:500}
.conn-status{width:8px;height:8px;border-radius:50%;background:#ed4245;margin-left:auto;transition:background .3s}
.conn-status.online{background:#3ba55d}
.main-content{flex:1;display:flex;flex-direction:column;background:#36393f}
.chat-header{height:48px;padding:0 16px;display:flex;align-items:center;border-bottom:1px solid #202225;color:#fff}
.current-channel{font-weight:600;font-size:16px}
.current-channel::before{content:'#';margin-right:4px;color:#72767d}
.current-channel.private::before{content:'@';color:#5865f2}
.messages{flex:1;overflow-y:auto;padding:16px}
.message{display:flex;padding:4px 0;margin-bottom:8px;position:relative;transition:background .15s}
.message:hover{background:rgba(0,0,0,.1);margin-left:-16px;margin-right:-16px;padding-left:16px;padding-right:16px;border-radius:4px}
.msg-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;margin-right:16px;flex-shrink:0}
.msg-content{flex:1;min-width:0}
.msg-header{display:flex;align-items:center;gap:6px;margin-bottom:2px}
.msg-author{font-weight:500;font-size:15px;color:#fff}
.msg-time{color:#72767d;font-size:12px}
.msg-text{color:#dcddde;font-size:15px;line-height:1.4;word-wrap:break-word;white-space:pre-wrap}
.msg-reply{background:#2f3136;border-left:3px solid #5865f2;padding:4px 8px;margin-bottom:4px;border-radius:0 4px 4px 0;font-size:13px;color:#96989d}
.msg-reply-author{color:#5865f2;font-weight:500}
.msg-actions{position:absolute;right:8px;top:-8px;background:#2f3136;border-radius:4px;display:none;box-shadow:0 2px 8px rgba(0,0,0,.4)}
.message:hover .msg-actions{display:flex}
.msg-action{background:none;border:none;color:#96989d;padding:6px 8px;cursor:pointer;font-size:14px;transition:all .15s}
.msg-action:hover{color:#fff;background:#3a3c42}
.reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.reaction{background:#3a3c42;border:1px solid transparent;border-radius:6px;padding:2px 6px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s}
.reaction:hover{border-color:#5865f2;transform:scale(1.05)}
.reaction.active{background:rgba(88,101,242,.3);border-color:#5865f2}
.reaction-count{font-size:12px;color:#dcddde}
.emoji-picker{position:absolute;bottom:100%;right:0;background:#2f3136;border-radius:8px;padding:8px;display:none;box-shadow:0 4px 12px rgba(0,0,0,.5);z-index:100;animation:fadeIn .2s}
.emoji-picker.show{display:grid;grid-template-columns:repeat(5,1fr);gap:4px}
.emoji-picker button{background:none;border:none;font-size:20px;cursor:pointer;padding:4px;border-radius:4px;transition:all .15s}
.emoji-picker button:hover{background:#3a3c42;transform:scale(1.2)}
.input-area{padding:0 16px 16px}
.typing-indicator{height:24px;font-size:12px;color:#72767d;font-style:italic;display:flex;align-items:center}
.reply-bar{background:#40444b;border-radius:8px 8px 0 0;padding:8px 12px;display:none;align-items:center;justify-content:space-between}
.reply-bar.show{display:flex}
.reply-bar-text{color:#dcddde;font-size:13px}
.reply-bar-close{background:none;border:none;color:#96989d;cursor:pointer;font-size:18px;transition:color .2s}
.reply-bar-close:hover{color:#fff}
.input-wrapper{background:#40444b;border-radius:8px;padding:12px;display:flex;align-items:center}
.reply-bar.show+.input-wrapper{border-radius:0 0 8px 8px}
.msg-input{flex:1;background:none;border:none;color:#dcddde;font-size:15px;outline:none}
.msg-input::placeholder{color:#72767d}
.send-btn{background:#5865f2;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:500;margin-left:8px;transition:background .2s}
.send-btn:hover{background:#4752c4}
.send-btn:disabled{background:#4e5058;cursor:not-allowed}
.notifs{position:fixed;top:16px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:8px;max-width:380px}
.notif{background:#2f3136;border:1px solid #202225;border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.4);animation:slideIn .3s}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.notif-title{color:#fff;font-weight:600;font-size:14px;margin-bottom:6px}
.notif-body{color:#dcddde;font-size:13px;margin-bottom:8px}
.notif-actions{display:flex;gap:8px}
.notif-btn{flex:1;padding:8px;border:none;border-radius:4px;font-weight:500;cursor:pointer;font-size:13px;transition:all .2s}
.notif-accept{background:#3ba55d;color:#fff}
.notif-accept:hover{background:#2d8659}
.notif-decline{background:#ed4245;color:#fff}
.notif-decline:hover{background:#c93b3e}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:#2f3136}
::-webkit-scrollbar-thumb{background:#202225;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#1a1c1f}
#loginOverlay{position:fixed;inset:0;z-index:2000;background:linear-gradient(135deg,#1a1c20 0%,#2f3136 50%,#1a1c20 100%);display:flex;align-items:center;justify-content:center;flex-direction:column}
.login-title{font-size:48px;color:#fff;margin-bottom:30px;text-shadow:0 0 20px rgba(88,101,242,.5)}
#loginCard{width:320px;background:#2f3136;border:1px solid #202225;border-radius:8px;padding:24px;color:#fff;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.3)}
#loginCard h2{margin-bottom:16px;font-size:20px}
#usernameInput{width:100%;padding:12px;border-radius:6px;border:none;background:#40444b;color:#fff;font-size:14px;transition:box-shadow .2s;margin-bottom:12px}
#usernameInput:focus{outline:none;box-shadow:0 0 0 2px #5865f2}
#loginBtn{width:100%;padding:12px;border:none;border-radius:6px;background:#5865f2;color:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:background .2s}
#loginBtn:hover{background:#4752c4}
#loginError{margin-top:10px;color:#ed4245;font-size:13px;min-height:20px}
.empty{text-align:center;color:#72767d;padding:12px;font-size:12px}
</style>
</head>
<body>
<div id="loginOverlay">
<div class="login-title">üí¨ Simple Chat</div>
<div id="loginCard">
<h2>Enter Username</h2>
<input type="text" id="usernameInput" placeholder="Your username" maxlength="30">
<button id="loginBtn">Join Chat</button>
<div id="loginError"></div>
</div>
</div>
<div class="notifs" id="notifs"></div>
<div class="container">
<div class="sidebar">
<div class="server-header">Simple Chat</div>
<div class="channels">
<div class="channel-section">
<div class="section-header">Channels</div>
<div class="channel active" data-channel="general"><span class="channel-name">general</span><span class="unread-badge">0</span></div>
<div class="channel" data-channel="random"><span class="channel-name">random</span><span class="unread-badge">0</span></div>
<div class="channel" data-channel="gaming"><span class="channel-name">gaming</span><span class="unread-badge">0</span></div>
</div>
<div class="channel-section">
<div class="section-header">Direct Messages</div>
<div id="dmList"></div>
</div>
</div>
<div class="user-area" id="userArea">
<div class="user-avatar" id="myAvatar">U</div>
<div class="user-display-name" id="myName">User</div>
<div class="conn-status" id="connStatus"></div>
</div>
</div>
<div class="main-content">
<div class="chat-header">
<div class="current-channel" id="curChan">general</div>
</div>
<div class="messages" id="msgArea"></div>
<div class="input-area">
<div class="typing-indicator" id="typingInd"></div>
<div class="reply-bar" id="replyBar">
<span class="reply-bar-text" id="replyText"></span>
<button class="reply-bar-close" id="cancelReply">√ó</button>
</div>
<div class="input-wrapper">
<input type="text" class="msg-input" id="msgInput" placeholder="Message #general" maxlength="2000">
<button class="send-btn" id="sendBtn">Send</button>
</div>
</div>
</div>
<div class="sidebar right">
<div class="server-header">
<span>Online Users</span>
<span class="online-count" id="onlineCount">0</span>
</div>
<div class="users-section">
<div class="role-header" id="usersHeader">Users</div>
<div id="usersList"></div>
</div>
</div>
</div>
<script>
const EMOJIS=['üëç','üëé','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','üéâ','üëÄ','üíØ'];
let ws,connected=false,username='',uuid=null;
let curChan='general',chatType='channel',curDM=null,replyTo=null;
const messages={},dmMessages={},dmPartners={},users=[],unreadChannels={},unreadDMs={};
const $=id=>document.getElementById(id);

function generateUUID(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)})}
function send(d){if(ws&&ws.readyState===1)ws.send(JSON.stringify(d))}
function notify(title,body,acts){
const n=document.createElement('div');n.className='notif';
n.innerHTML=`<div class="notif-title">${title}</div><div class="notif-body">${body}</div>${acts||''}`;
$('notifs').appendChild(n);
if(!acts)setTimeout(()=>n.remove(),4000);
return n;
}

function connect(){
const url=location.protocol==='https:'?`wss://${location.host}`:`ws://${location.hostname}:${location.port||3000}`;
ws=new WebSocket(url);
ws.onopen=()=>{
connected=true;$('connStatus').classList.add('online');$('sendBtn').disabled=false;
send({type:'join',username,uuid});
send({type:'getHistory',channel:curChan});
};
ws.onclose=()=>{connected=false;$('connStatus').classList.remove('online');$('sendBtn').disabled=true;setTimeout(connect,3000)};
ws.onmessage=e=>{try{handle(JSON.parse(e.data))}catch(er){console.error(er)}};
}

function handle(d){
const h={
joined:()=>{if(d.uuid){uuid=d.uuid;localStorage.setItem('uuid',uuid)}},
message:()=>{
if(!messages[d.message.channel])messages[d.message.channel]=[];
messages[d.message.channel].push(d.message);
if(d.message.channel===curChan&&chatType==='channel')render();
else{
unreadChannels[d.message.channel]=(unreadChannels[d.message.channel]||0)+1;
updateUnreadBadge(d.message.channel);
notify('üí¨ New Message',`#${d.message.channel}: ${d.message.author}: ${d.message.text.slice(0,50)}`);
}
},
history:()=>{messages[d.channel]=d.messages;if(d.channel===curChan&&chatType==='channel')render()},
userList:()=>{users.length=0;users.push(...d.users);updUsers()},
typing:()=>{if((d.isPrivate&&dmPartners[curDM]===d.username)||(!d.isPrivate&&d.channel===curChan)){$('typingInd').textContent=d.isTyping?`${d.username} is typing...`:''}},
privateChatRequest:()=>{
const n=notify('üí¨ DM Request',`${d.from} wants to chat`,`<div class="notif-actions"><button class="notif-btn notif-accept" data-a="y">Accept</button><button class="notif-btn notif-decline" data-a="n">Decline</button></div>`);
n.querySelector('[data-a="y"]').onclick=()=>{send({type:'privateChatResponse',from:d.from,accepted:true});n.remove()};
n.querySelector('[data-a="n"]').onclick=()=>{send({type:'privateChatResponse',from:d.from,accepted:false});n.remove()};
},
privateChatAccepted:()=>{dmPartners[d.chatId]=d.with;addDM(d.chatId,d.with);switchDM(d.chatId,d.with)},
privateChatRejected:()=>notify('‚ùå',`${d.by} declined`),
privateMessage:()=>{
if(!dmMessages[d.message.chatId])dmMessages[d.message.chatId]=[];
dmMessages[d.message.chatId].push(d.message);
if(d.message.chatId===curDM&&chatType==='dm')render();
else{
unreadDMs[d.message.chatId]=(unreadDMs[d.message.chatId]||0)+1;
updateDMBadge(d.message.chatId);
const partner=dmPartners[d.message.chatId];
notify('üí¨ New DM',`@${partner}: ${d.message.text.slice(0,50)}`);
}
},
privateHistory:()=>{dmMessages[d.chatId]=d.messages;if(d.chatId===curDM&&chatType==='dm')render()},
reactionUpdate:()=>{const arr=d.isPrivate?dmMessages[d.chatId]:messages[d.channel];const m=arr?.find(x=>x.id===d.messageId);if(m){m.reactions=d.reactions;render()}},
error:()=>notify('‚ùå',d.message)
};
if(h[d.type])h[d.type]();
}

function updateUnreadBadge(channel){
const el=document.querySelector(`[data-channel="${channel}"]`);
if(!el)return;
const badge=el.querySelector('.unread-badge');
const count=unreadChannels[channel]||0;
if(badge){badge.textContent=count;el.classList.toggle('has-unread',count>0)}
}

function updateDMBadge(chatId){
const el=document.querySelector(`[data-dm="${chatId}"]`);
if(!el)return;
const count=unreadDMs[chatId]||0;
if(count>0){
let badge=el.querySelector('.dm-badge');
if(!badge){badge=document.createElement('span');badge.className='dm-badge';el.appendChild(badge)}
badge.textContent=count;
el.classList.add('has-unread');
}else{
const badge=el.querySelector('.dm-badge');
if(badge)badge.remove();
el.classList.remove('has-unread');
}
}

function updUsers(){
const makeItem=(u)=>`<div class="user-item"><span class="user-name">${u.username}</span><button class="dm-btn" onclick="reqDM('${u.username}')">DM</button></div>`;
$('usersList').innerHTML=users.filter(u=>u.username!==username).map(makeItem).join('');
$('onlineCount').textContent=users.length-1;
}

function reqDM(u){send({type:'privateChatRequest',targetUsername:u})}
function addDM(id,name){
if(document.querySelector(`[data-dm="${id}"]`))return;
const el=document.createElement('div');el.className='channel private';el.dataset.dm=id;
el.innerHTML=`<span class="channel-name">${name}</span><button class="close-dm">√ó</button>`;
el.querySelector('.close-dm').onclick=e=>{e.stopPropagation();el.remove();delete dmPartners[id];delete dmMessages[id];delete unreadDMs[id];if(curDM===id)switchChan('general')};
el.onclick=()=>switchDM(id,name);
$('dmList').appendChild(el);
}

function switchChan(ch){
chatType='channel';curDM=null;curChan=ch;
$('curChan').textContent=ch;$('curChan').classList.remove('private');
$('msgInput').placeholder=`Message #${ch}`;
document.querySelectorAll('.channel').forEach(c=>{c.classList.remove('active');if(c.dataset.channel===ch)c.classList.add('active')});
if(!messages[ch])send({type:'getHistory',channel:ch});else render();
unreadChannels[ch]=0;
updateUnreadBadge(ch);
}

function switchDM(id,name){
chatType='dm';curDM=id;
$('curChan').textContent=name;$('curChan').classList.add('private');
$('msgInput').placeholder=`Message @${name}`;
document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
document.querySelector(`[data-dm="${id}"]`)?.classList.add('active');
if(!dmMessages[id])send({type:'getPrivateHistory',chatId:id});else render();
unreadDMs[id]=0;
updateDMBadge(id);
}

function render(){
const arr=chatType==='dm'?dmMessages[curDM]||[]:messages[curChan]||[];
$('msgArea').innerHTML=arr.map(m=>{
const replyHtml=m.replyTo?`<div class="msg-reply"><span class="msg-reply-author">‚Ü© ${m.replyTo.author}:</span> ${m.replyTo.text}</div>`:'';
let reactHtml='';
if(m.reactions&&Object.keys(m.reactions).length){
reactHtml='<div class="reactions">'+Object.entries(m.reactions).map(([e,u])=>`<div class="reaction${u.includes(username)?' active':''}" onclick="${u.includes(username)?'remReact':'addReact'}('${m.id}','${e}')">${e}<span class="reaction-count">${u.length}</span></div>`).join('')+'</div>';
}
return `<div class="message" data-id="${m.id}"><div class="msg-avatar">${m.author[0].toUpperCase()}</div><div class="msg-content">${replyHtml}<div class="msg-header"><span class="msg-author">${m.author}</span><span class="msg-time">${new Date(m.timestamp).toLocaleTimeString().slice(0,5)}</span></div><div class="msg-text">${esc(m.text)}</div>${reactHtml}</div><div class="msg-actions"><button class="msg-action" onclick='setReply(${JSON.stringify({id:m.id,author:m.author,text:m.text.slice(0,50)}).replace(/'/g,"&#39;")})'>‚Ü©</button><button class="msg-action" onclick="toggleEmoji('${m.id}')">üòÄ</button></div><div class="emoji-picker" id="ep-${m.id}">${EMOJIS.map(e=>`<button onclick="addReact('${m.id}','${e}');toggleEmoji('${m.id}')">${e}</button>`).join('')}</div></div>`;
}).join('');
$('msgArea').scrollTop=$('msgArea').scrollHeight;
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function toggleEmoji(id){document.querySelectorAll('.emoji-picker').forEach(p=>p.classList.remove('show'));$('ep-'+id)?.classList.toggle('show')}
function addReact(id,e){send({type:'addReaction',messageId:id,emoji:e,channel:curChan,isPrivate:chatType==='dm',chatId:curDM})}
function remReact(id,e){send({type:'removeReaction',messageId:id,emoji:e,channel:curChan,isPrivate:chatType==='dm',chatId:curDM})}
function setReply(r){replyTo=r;$('replyText').innerHTML=`Replying to <b>${r.author}</b>`;$('replyBar').classList.add('show');$('msgInput').focus()}
function clearReply(){replyTo=null;$('replyBar').classList.remove('show')}

function sendMsg(){
const t=$('msgInput').value.trim();
if(!t||!connected)return;
if(chatType==='dm')send({type:'privateMessage',chatId:curDM,text:t,targetUsername:dmPartners[curDM],replyTo});
else send({type:'message',channel:curChan,text:t,replyTo});
$('msgInput').value='';
clearReply();
}

document.addEventListener('DOMContentLoaded',()=>{
$('loginBtn').onclick=()=>{
let u=$('usernameInput').value.trim();
if(!u){$('loginError').textContent='Please enter a username';return}
username=u.slice(0,30);
$('myName').textContent=username;
$('myAvatar').childNodes[0].textContent=username[0].toUpperCase();
uuid=localStorage.getItem('uuid')||null;
$('loginOverlay').style.display='none';
connect();
};
$('usernameInput').onkeypress=e=>{if(e.key==='Enter')$('loginBtn').click()};
$('sendBtn').onclick=sendMsg;
$('msgInput').onkeypress=e=>{if(e.key==='Enter')sendMsg()};
$('cancelReply').onclick=clearReply;
document.querySelectorAll('.channel[data-channel]').forEach(c=>{c.onclick=()=>switchChan(c.dataset.channel)});
document.onclick=e=>{if(!e.target.closest('.emoji-picker')&&!e.target.closest('.msg-action'))document.querySelectorAll('.emoji-picker').forEach(p=>p.classList.remove('show'))};
});
</script>
</body>
</html>
