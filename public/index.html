<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chet</title>
    <link rel="icon" type="image/png" id="favicon">
    <style>
        /* --- RESET & BASIC SETUP --- */
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: 'gg sans', 'Segoe UI', 'Roboto', sans-serif; height: 100vh; overflow: hidden; background: #36393f; color: #dcddde;}
        
        /* --- LAYOUT GRID --- */
        .container { display: flex; height: 100vh; }
        
        /* 1. LEFT SIDEBAR (Channels) */
        .sidebar-left { width: 240px; background: #2f3136; display: flex; flex-direction: column; flex-shrink: 0; }
        .server-header { height: 48px; padding: 0 16px; display: flex; align-items: center; font-weight: 700; color: #fff; box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        .channel-list { flex: 1; padding: 8px; overflow-y: auto; }
        .channel-group { margin-bottom: 16px; }
        .group-label { font-size: 12px; font-weight: 700; color: #96989d; text-transform: uppercase; padding: 0 8px 4px; }
        
        .channel { padding: 6px 8px; margin: 1px 0; border-radius: 4px; color: #96989d; cursor: pointer; display: flex; align-items: center; }
        .channel:hover { background: #393c43; color: #dcddde; }
        .channel.active { background: #393c43; color: #fff; }
        .channel::before { content: '#'; font-size: 20px; color: #72767d; margin-right: 6px; }
        .channel.private::before { content: '@'; font-size: 16px; }

        /* USER AREA (Bottom Left) */
        .user-area { height: 52px; background: #292b2f; display: flex; align-items: center; padding: 0 8px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #5865f2; margin-right: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        .user-details { flex: 1; font-size: 14px; }
        .user-name { font-weight: 600; color: #fff; }
        .user-status { font-size: 12px; color: #b9bbbe; }
        
        /* LOCK BUTTON */
        .admin-lock-btn { background: none; border: none; color: #b9bbbe; cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; }
        .admin-lock-btn:hover { color: #fff; background: #3f4147; }
        .admin-lock-btn.active { color: #3ba55d; }

        /* 2. MAIN CHAT AREA (Middle) */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #36393f; min-width: 0; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; border-bottom: 1px solid #26272d; color: #fff; font-weight: 700; box-shadow: 0 1px 0 rgba(0,0,0,0.06); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        
        /* Messages */
        .message { margin-bottom: 16px; display: flex; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 16px; flex-shrink: 0; background: #5865f2; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        .msg-content { flex: 1; overflow-wrap: anywhere; }
        .msg-header { display: flex; align-items: baseline; margin-bottom: 2px; }
        .msg-author { font-weight: 600; color: #fff; margin-right: 8px; cursor: pointer; }
        .msg-author:hover { text-decoration: underline; }
        .msg-time { font-size: 12px; color: #72767d; }
        .msg-text { color: #dcddde; line-height: 1.4; }
        .msg-img { max-width: 350px; border-radius: 8px; margin-top: 6px; cursor: pointer; }

        /* Input */
        .chat-input-area { padding: 0 16px 24px; }
        .input-wrapper { background: #40444b; padding: 0 16px; border-radius: 8px; display: flex; align-items: center; }
        .attach-btn { background: none; border: none; color: #b9bbbe; font-size: 24px; cursor: pointer; margin-right: 16px; }
        .message-input { flex: 1; background: none; border: none; padding: 11px 0; color: #dcddde; outline: none; height: 44px; }
        
        /* 3. RIGHT SIDEBAR (Members) */
        .sidebar-right { width: 240px; background: #2f3136; display: flex; flex-direction: column; border-left: 1px solid #2f3136; overflow: hidden; }
        .members-header { padding: 24px 16px 8px; font-weight: 700; color: #96989d; font-size: 12px; text-transform: uppercase; }
        .member-list { flex: 1; overflow-y: auto; padding: 0 8px; }
        
        .member { display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; cursor: pointer; opacity: 0.9; margin-bottom: 2px; }
        .member:hover { background: #36393f; opacity: 1; }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; background: #5865f2; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; position: relative; }
        .status-indicator { position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; border-radius: 50%; background: #3ba55d; border: 3px solid #2f3136; }
        .member-info { flex: 1; overflow: hidden; }
        .member-name { font-weight: 500; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
        
        /* Action Buttons in Member List */
        .member-actions { display: none; gap: 4px; }
        .member:hover .member-actions { display: flex; }
        .icon-btn { background: #36393f; border: none; color: #b9bbbe; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .icon-btn:hover { background: #202225; color: #fff; }
        .icon-btn.admin-action { color: #ed4245; }
        
        /* MODALS & POPUPS */
        .admin-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #36393f; padding: 20px; border-radius: 8px; width: 300px; z-index: 1000; box-shadow: 0 0 0 100vw rgba(0,0,0,0.7); display: none; }
        .admin-modal.active { display: block; }
        .admin-modal h3 { color: #fff; margin-bottom: 16px; }
        .admin-opt { width: 100%; padding: 10px; margin: 4px 0; background: #2f3136; border: none; color: #dcddde; text-align: left; cursor: pointer; border-radius: 4px; }
        .admin-opt:hover { background: #40444b; color: #fff; }
        .admin-opt.danger { color: #ed4245; border: 1px solid #ed4245; }
        .admin-opt.danger:hover { background: #ed4245; color: #fff; }
        .close-modal { margin-top: 8px; width: 100%; padding: 8px; background: transparent; border: none; color: #aaa; cursor: pointer; }

        .img-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .img-viewer.active { display: flex; }
        .img-viewer img { max-width: 90%; max-height: 90%; border-radius: 4px; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2b2d31; }
        ::-webkit-scrollbar-thumb { background: #1a1b1e; border-radius: 4px; }
    </style>
</head>
<body>

<div class="admin-modal" id="adminModal">
    <h3 id="adminModalTitle">Admin Actions</h3>
    <button class="admin-opt" onclick="executeAdmin('mute', 1)">Mute 1 Minute</button>
    <button class="admin-opt" onclick="executeAdmin('mute', 5)">Mute 5 Minutes</button>
    <button class="admin-opt" onclick="executeAdmin('mute', 999999)">Mute Forever</button>
    <div style="height: 1px; background: #4f545c; margin: 8px 0;"></div>
    <button class="admin-opt danger" onclick="executeAdmin('kick')">Kick to Google</button>
    <button class="admin-opt danger" onclick="executeAdmin('ban')">Permanently Ban IP</button>
    <button class="close-modal" onclick="closeAdminModal()">Cancel</button>
</div>

<div class="img-viewer" id="imgViewer" onclick="this.classList.remove('active')">
    <img id="viewingImg" src="">
</div>

<div class="container">
    
    <div class="sidebar-left">
        <div class="server-header">The Chet</div>
        <div class="channel-list">
            <div class="channel-group">
                <div class="group-label">Text Channels</div>
                <div class="channel active" onclick="switchChannel('general', this)">general</div>
                <div class="channel" onclick="switchChannel('gaming', this)">gaming</div>
                <div class="channel" onclick="switchChannel('memes', this)">memes</div>
                <div class="channel" onclick="switchChannel('random', this)">random</div>
            </div>
            <div class="channel-group">
                <div class="group-label">Direct Messages</div>
                <div id="dmList"></div>
            </div>
        </div>
        
        <div class="user-area">
            <div class="user-avatar" id="myAvatar"></div>
            <div class="user-details">
                <div class="user-name" id="myName">...</div>
                <div class="user-status" id="connectionStatus">Connecting...</div>
            </div>
            <button class="admin-lock-btn" id="lockBtn" title="Admin Login" onclick="attemptAdminLogin()">üîí</button>
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <span style="font-size: 24px; color: #72767d; margin-right: 8px;">#</span>
            <span id="headerName">general</span>
        </div>
        <div class="chat-messages" id="messageArea"></div>
        <div class="chat-input-area">
            <div class="input-wrapper">
                <button class="attach-btn" onclick="document.getElementById('fileInput').click()">+</button>
                <input type="file" id="fileInput" hidden accept="image/*">
                <input type="text" class="message-input" id="msgInput" placeholder="Message #general">
            </div>
        </div>
    </div>

    <div class="sidebar-right">
        <div class="members-header" id="membersHeader">Online ‚Äî 0</div>
        <div class="member-list" id="memberList">
            </div>
    </div>
</div>

<script>
    // State
    const state = {
        username: '',
        color: '#5865f2',
        isAdmin: false,
        currentChannel: 'general',
        ws: null,
        selectedUser: null, // For admin actions
        dmId: null
    };

    // DOM Elements
    const els = {
        msgArea: document.getElementById('messageArea'),
        msgInput: document.getElementById('msgInput'),
        memberList: document.getElementById('memberList'),
        membersHeader: document.getElementById('membersHeader'),
        dmList: document.getElementById('dmList'),
        lockBtn: document.getElementById('lockBtn'),
        adminModal: document.getElementById('adminModal'),
        headerName: document.getElementById('headerName')
    };

    // --- Init ---
    function init() {
        state.username = prompt("Enter Username:") || "User" + Math.floor(Math.random()*1000);
        document.getElementById('myName').textContent = state.username;
        document.getElementById('myAvatar').textContent = state.username[0].toUpperCase();
        connect();
    }

    function connect() {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        state.ws = new WebSocket(`${protocol}//${location.host}`);

        state.ws.onopen = () => {
            document.getElementById('connectionStatus').textContent = "Online";
            document.getElementById('connectionStatus').style.color = "#3ba55d";
            send({ type: 'join', username: state.username });
        };

        state.ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
        
        state.ws.onclose = () => {
            document.getElementById('connectionStatus').textContent = "Disconnected";
            document.getElementById('connectionStatus').style.color = "#ed4245";
            setTimeout(connect, 3000);
        };
    }

    function send(data) {
        if(state.ws && state.ws.readyState === 1) state.ws.send(JSON.stringify(data));
    }

    // --- Handling Messages ---
    function handleMessage(data) {
        switch(data.type) {
            case 'history':
                els.msgArea.innerHTML = '';
                if(data.username) state.username = data.username; // Sync name if server changed it
                data.messages.forEach(renderMessage);
                break;
            case 'message': 
                renderMessage(data.message); 
                break;
            case 'userList': 
                renderMemberList(data.users); 
                break;
            case 'adminSuccess':
                state.isAdmin = true;
                els.lockBtn.classList.add('active');
                alert("Admin Access Granted");
                break;
            case 'kicked':
                window.location.href = "https://www.google.com";
                break;
            case 'info':
                alert(data.message);
                break;
            case 'error':
                alert("Error: " + data.message);
                break;
            
            // Private Chat Handling
            case 'privateChatRequest':
                if(confirm(`${data.from} wants to DM you. Accept?`)) {
                    send({ type: 'privateChatResponse', from: data.from, accepted: true });
                }
                break;
            case 'privateChatAccepted':
                setupDM(data.chatId, data.with);
                break;
            case 'privateMessage':
                if (state.dmId === data.message.chatId) {
                    renderMessage(data.message);
                }
                break;
        }
    }

    // --- Rendering ---
    function renderMemberList(users) {
        els.memberList.innerHTML = '';
        els.membersHeader.textContent = `ONLINE ‚Äî ${users.length}`;
        
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'member';
            // Show crown if they are admin
            const adminBadge = u.isAdmin ? 'üëë ' : '';
            
            let buttons = `<button class="icon-btn" title="DM" onclick="requestDM('${u.username}')">üí¨</button>`;
            
            // Only add Admin "Gear" button if *I* am an admin
            if (state.isAdmin && u.username !== state.username) {
                buttons += `<button class="icon-btn admin-action" title="Admin Actions" onclick="openAdminModal('${u.username}')">‚ö†Ô∏è</button>`;
            }

            div.innerHTML = `
                <div class="member-avatar">${u.username[0].toUpperCase()}<div class="status-indicator"></div></div>
                <div class="member-info">
                    <div class="member-name">${adminBadge}${u.username}</div>
                </div>
                <div class="member-actions">
                    ${u.username !== state.username ? buttons : ''}
                </div>
            `;
            els.memberList.appendChild(div);
        });
    }

    function renderMessage(msg) {
        if (state.dmId && msg.channel) return; // Ignore public msg in DM
        if (!state.dmId && msg.chatId) return; // Ignore DM msg in public

        // Public check: must match current channel
        if (!state.dmId && msg.channel !== state.currentChannel) return;

        const div = document.createElement('div');
        div.className = 'message';
        
        let content = `<div class="msg-text">${msg.text || ''}</div>`;
        if (msg.isImage) {
            content = `<img class="msg-img" src="${msg.imageData}" onclick="viewImage(this.src)">`;
        }

        div.innerHTML = `
            <div class="msg-avatar" style="background:${msg.color || '#5865f2'}" onclick="openAdminModal('${msg.author}')">${msg.author[0].toUpperCase()}</div>
            <div class="msg-content">
                <div class="msg-header">
                    <span class="msg-author" onclick="openAdminModal('${msg.author}')">${msg.author}</span>
                    <span class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                </div>
                ${content}
            </div>
        `;
        els.msgArea.appendChild(div);
        els.msgArea.scrollTop = els.msgArea.scrollHeight;
    }

    // --- Admin Functions ---
    function attemptAdminLogin() {
        if (state.isAdmin) return alert("You are already Admin.");
        const pass = prompt("Enter Admin Password:");
        if (pass) send({ type: 'adminLogin', password: pass });
    }

    function openAdminModal(targetUser) {
        if (!state.isAdmin) return; // Prevent non-admins from opening
        if (targetUser === state.username) return;

        state.selectedUser = targetUser;
        document.getElementById('adminModalTitle').textContent = `Admin: ${targetUser}`;
        els.adminModal.classList.add('active');
    }

    function closeAdminModal() {
        els.adminModal.classList.remove('active');
        state.selectedUser = null;
    }

    function executeAdmin(action, duration = 0) {
        if (!state.selectedUser) return;
        send({
            type: 'adminAction',
            action: action,
            target: state.selectedUser,
            duration: duration
        });
        closeAdminModal();
    }

    // --- Channel & DM Logic ---
    function switchChannel(channelName, element) {
        state.currentChannel = channelName;
        state.dmId = null;
        
        // UI Updates
        document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
        if(element) element.classList.add('active');
        els.headerName.textContent = channelName;
        els.msgInput.placeholder = `Message #${channelName}`;
        
        // Get History
        send({ type: 'join', username: state.username }); // Re-join to clear context
    }

    function requestDM(target) {
        send({ type: 'privateChatRequest', targetUsername: target });
    }

    function setupDM(chatId, withUser) {
        state.dmId = chatId;
        state.currentChannel = null;
        
        // Add to sidebar if not present
        let dmEl = document.getElementById(`dm-${chatId}`);
        if (!dmEl) {
            dmEl = document.createElement('div');
            dmEl.id = `dm-${chatId}`;
            dmEl.className = 'channel private active';
            dmEl.innerHTML = `<span>${withUser}</span>`;
            dmEl.onclick = () => {
                 document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
                 dmEl.classList.add('active');
                 state.dmId = chatId;
                 state.currentChannel = null;
                 els.headerName.textContent = `@${withUser}`;
                 els.msgArea.innerHTML = ''; // Clear public chat
                 els.msgInput.placeholder = `Message @${withUser}`;
            };
            els.dmList.appendChild(dmEl);
        }
        
        // Activate it
        dmEl.click();
    }

    // --- Sending ---
    els.msgInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const text = els.msgInput.value.trim();
            if (!text) return;
            
            const payload = {
                text: text,
                timestamp: Date.now()
            };

            if (state.dmId) {
                payload.type = 'privateMessage';
                payload.chatId = state.dmId;
                // We need to store target username somewhere for DMs, simplified here:
                // Note: For DMs to work perfectly, we'd map chatIds to participants.
                // In this simplified reset version, we rely on server broadcasting to chatId group.
                // However, the server requires targetUsername for privateMessage.
                // Let's hack it: get username from header text (remove @)
                payload.targetUsername = els.headerName.textContent.replace('@', '');
            } else {
                payload.type = 'message';
                payload.channel = state.currentChannel;
            }

            send(payload);
            els.msgInput.value = '';
        }
    });

    // File Upload
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const payload = {
                type: 'imageMessage',
                imageData: ev.target.result,
                channel: state.currentChannel
            };
            send(payload);
        };
        reader.readAsDataURL(file);
    });

    // Img Viewer
    function viewImage(src) {
        document.getElementById('viewingImg').src = src;
        document.getElementById('imgViewer').classList.add('active');
    }

    init();
</script>
</body>
</html>
