<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discord Clone - Debug</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;height:100vh;overflow:hidden;background:#36393f;color:#dcddde}
.debug-panel{position:fixed;bottom:0;left:0;right:0;background:#1a1c20;color:#0f0;padding:12px;font-family:monospace;font-size:11px;max-height:150px;overflow-y:auto;border-top:2px solid #0f0;z-index:9999}
.debug-panel .error{color:#f00}
.debug-panel .success{color:#0f0}
.debug-panel .warning{color:#ff0}
.debug-panel .info{color:#0af}
.container{display:flex;height:calc(100vh - 150px)}
.sidebar{width:240px;background:#2f3136;display:flex;flex-direction:column}
.sidebar.right{border-left:1px solid #202225}
.server-header{height:48px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #202225;color:#fff;font-weight:600;font-size:15px}
.channels{flex:1;overflow-y:auto;padding:8px}
.channel-section{margin-bottom:16px}
.section-header{color:#96989d;font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:4px;padding:0 8px}
.channel{padding:8px 12px;margin:2px 0;border-radius:4px;color:#96989d;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:14px;transition:all .15s}
.channel:hover{background:#3a3c42;color:#dcddde}
.channel.active{background:#404249;color:#fff}
.channel-name{display:flex;align-items:center}
.channel-name::before{content:'#';margin-right:6px;font-weight:600;color:#72767d}
.user-area{height:52px;background:#292b2f;padding:0 8px;display:flex;align-items:center}
.my-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;margin-right:8px;font-size:14px;background:#5865f2}
.conn-status{width:12px;height:12px;border-radius:50%;background:#ed4245;margin-left:auto;transition:background .3s}
.conn-status.online{background:#3ba55d}
.main-content{flex:1;display:flex;flex-direction:column;background:#36393f}
.chat-header{height:48px;padding:0 16px;display:flex;align-items:center;border-bottom:1px solid #202225;color:#fff;font-weight:600;font-size:16px}
.messages{flex:1;overflow-y:auto;padding:16px}
.message{display:flex;padding:8px;margin-bottom:8px;background:rgba(0,0,0,.1);border-radius:4px}
.msg-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;margin-right:16px;flex-shrink:0}
.msg-content{flex:1}
.msg-author{font-weight:500;font-size:15px;margin-bottom:4px}
.msg-text{color:#dcddde;font-size:15px;line-height:1.4}
.input-area{padding:16px}
.input-wrapper{background:#40444b;border-radius:8px;padding:12px;display:flex;align-items:center}
.msg-input{flex:1;background:none;border:none;color:#dcddde;font-size:15px;outline:none}
.send-btn{background:#5865f2;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:500;margin-left:8px}
.send-btn:disabled{background:#4e5058;opacity:.5}
#loginOverlay{position:fixed;inset:0;z-index:2000;background:linear-gradient(135deg,#1a1c20,#2f3136);display:flex;align-items:center;justify-content:center}
#loginCard{width:400px;background:#2f3136;border:1px solid #202225;border-radius:8px;padding:32px;color:#fff}
#loginCard h1{margin-bottom:8px;font-size:24px;text-align:center}
#loginCard p{text-align:center;color:#96989d;margin-bottom:24px;font-size:14px}
.input-group{margin-bottom:16px}
.input-label{display:block;font-size:12px;font-weight:600;color:#96989d;margin-bottom:8px;text-transform:uppercase}
.login-input{width:100%;padding:10px;border-radius:4px;border:1px solid #202225;background:#202225;color:#fff;font-size:14px}
.login-btn{width:100%;margin-top:8px;padding:12px;border:none;border-radius:4px;background:#5865f2;color:#fff;cursor:pointer;font-weight:600;font-size:14px}
.role-info{margin-top:16px;padding:12px;background:#202225;border-radius:4px;font-size:12px;color:#96989d}
.users-section{flex:1;overflow-y:auto;padding:8px}
.user-item{padding:8px 12px;color:#dcddde;font-size:13px;border-radius:4px;margin:4px}
</style>
</head>
<body>
<div id="loginOverlay">
<div id="loginCard">
<h1>üîç Discord Clone - Debug Mode</h1>
<p>Watch the console at the bottom for diagnostic info</p>
<div class="input-group">
<label class="input-label">Username</label>
<input type="text" class="login-input" id="usernameInput" placeholder="Enter your username" value="TestUser">
</div>
<div class="input-group">
<label class="input-label">Role Passcode (Optional)</label>
<input type="password" class="login-input" id="passcodeInput" placeholder="Leave blank for member">
</div>
<button class="login-btn" id="loginBtn">Join Server</button>
<div class="role-info">
<strong>Debug Info:</strong><br>
This version shows connection status and errors
</div>
</div>
</div>

<div class="container">
<div class="sidebar">
<div class="server-header">Discord Clone</div>
<div class="channels">
<div class="channel-section">
<div class="section-header">Text Channels</div>
<div class="channel active" data-channel="general">
<span class="channel-name">general</span>
</div>
</div>
</div>
<div class="user-area">
<div class="my-avatar" id="myAvatar">U</div>
<div style="flex:1">
<div style="font-size:14px;font-weight:500;color:#fff" id="myUsername">User</div>
<div style="font-size:12px;color:#72767d" id="statusText">Offline</div>
</div>
<div class="conn-status" id="connStatus"></div>
</div>
</div>

<div class="main-content">
<div class="chat-header">
<div id="currentChannel">#general</div>
</div>
<div class="messages" id="messagesArea"></div>
<div class="input-area">
<div class="input-wrapper">
<input type="text" class="msg-input" id="messageInput" placeholder="Message #general">
<button class="send-btn" id="sendBtn" disabled>Send</button>
</div>
</div>
</div>

<div class="sidebar right">
<div class="server-header">Members</div>
<div class="users-section" id="usersList">
<div style="padding:12px;color:#72767d;text-align:center">Waiting for connection...</div>
</div>
</div>
</div>

<div class="debug-panel" id="debugPanel"></div>

<script>
const $ = id => document.getElementById(id);
let ws, username = '', role = 'user';

function log(msg, type = 'info') {
  const panel = $('debugPanel');
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = type;
  entry.textContent = `[${time}] ${msg}`;
  panel.appendChild(entry);
  panel.scrollTop = panel.scrollHeight;
  console.log(`[${type.toUpperCase()}]`, msg);
}

function connect() {
  log('üîå Attempting to connect to ws://localhost:3001...', 'info');
  
  try {
    ws = new WebSocket('ws://localhost:3001');
    
    ws.onopen = function() {
      log('‚úÖ WebSocket connection opened!', 'success');
      $('connStatus').classList.add('online');
      $('statusText').textContent = 'Online';
      $('statusText').style.color = '#3ba55d';
      $('sendBtn').disabled = false;
      
      const joinMsg = {
        type: 'join',
        username: username,
        role: role
      };
      log('üì§ Sending join message: ' + JSON.stringify(joinMsg), 'info');
      ws.send(JSON.stringify(joinMsg));
    };

    ws.onerror = function(error) {
      log('‚ùå WebSocket ERROR: ' + error, 'error');
      log('‚ö†Ô∏è Make sure the server is running on port 3001!', 'warning');
    };

    ws.onclose = function(event) {
      log('üîå WebSocket closed. Code: ' + event.code + ', Reason: ' + event.reason, 'warning');
      $('connStatus').classList.remove('online');
      $('statusText').textContent = 'Disconnected';
      $('statusText').style.color = '#ed4245';
      $('sendBtn').disabled = true;
      log('üîÑ Reconnecting in 3 seconds...', 'info');
      setTimeout(connect, 3000);
    };

    ws.onmessage = function(e) {
      log('üì• Received message: ' + e.data.substring(0, 100) + '...', 'info');
      try {
        const data = JSON.parse(e.data);
        handleMessage(data);
      } catch (err) {
        log('‚ùå Error parsing message: ' + err.message, 'error');
      }
    };
  } catch (err) {
    log('‚ùå Failed to create WebSocket: ' + err.message, 'error');
  }
}

function handleMessage(data) {
  log('üì® Handling message type: ' + data.type, 'info');
  
  switch(data.type) {
    case 'users':
      log('üë• Received users list: ' + data.users.length + ' users', 'success');
      renderUsers(data.users);
      break;
    case 'message':
      log('üí¨ Received channel message from ' + data.username, 'success');
      displayMessage(data);
      break;
    case 'error':
      log('‚ùå Server error: ' + data.message, 'error');
      break;
    default:
      log('‚ö†Ô∏è Unknown message type: ' + data.type, 'warning');
  }
}

function renderUsers(users) {
  const html = users.map(u => 
    `<div class="user-item">
      <div style="display:flex;align-items:center">
        <div class="msg-avatar" style="width:24px;height:24px;font-size:11px;margin-right:8px;background:#5865f2">
          ${u.username.charAt(0).toUpperCase()}
        </div>
        ${u.username} ${u.role !== 'user' ? '(' + u.role + ')' : ''}
      </div>
    </div>`
  ).join('');
  $('usersList').innerHTML = html || '<div style="padding:12px;color:#72767d;text-align:center">No users</div>';
}

function displayMessage(msg) {
  const msgEl = document.createElement('div');
  msgEl.className = 'message';
  msgEl.innerHTML = `
    <div class="msg-avatar" style="background:#5865f2">
      ${msg.username.charAt(0).toUpperCase()}
    </div>
    <div class="msg-content">
      <div class="msg-author">${msg.username}</div>
      <div class="msg-text">${escapeHtml(msg.message)}</div>
    </div>
  `;
  $('messagesArea').appendChild(msgEl);
  $('messagesArea').scrollTop = $('messagesArea').scrollHeight;
}

function sendMessage() {
  const text = $('messageInput').value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) {
    log('‚ö†Ô∏è Cannot send message - not connected', 'warning');
    return;
  }
  
  const msg = {
    type: 'message',
    channel: 'general',
    message: text
  };
  log('üì§ Sending message: ' + text, 'info');
  ws.send(JSON.stringify(msg));
  $('messageInput').value = '';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  log('üöÄ Page loaded! Ready to connect.', 'success');
  
  $('loginBtn').onclick = function() {
    username = $('usernameInput').value.trim();
    const pass = $('passcodeInput').value.trim();
    
    if (!username) {
      log('‚ùå Username is required!', 'error');
      alert('Please enter a username');
      return;
    }
    
    if (pass === '10owna12') {
      role = 'owner';
      log('üëë Logging in as OWNER', 'success');
    } else if (pass === 'nimda-1818') {
      role = 'admin';
      log('‚ö° Logging in as ADMIN', 'success');
    } else {
      role = 'user';
      log('üë§ Logging in as USER', 'info');
    }
    
    $('myUsername').textContent = username;
    $('myAvatar').textContent = username.charAt(0).toUpperCase();
    $('loginOverlay').style.display = 'none';
    
    log('‚úÖ Login successful! Username: ' + username + ', Role: ' + role, 'success');
    connect();
  };
  
  $('sendBtn').onclick = sendMessage;
  $('messageInput').onkeypress = function(e) {
    if (e.key === 'Enter') sendMessage();
  };
});
</script>
</body>
</html>
